<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chal√© Guadalupe - Reservas</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Rye&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK (Compat - As requested to maintain logic compatibility) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        chale: {
                            red: '#9F0402',
                            redLight: '#c12624',
                            yellow: '#F7931E',
                            cream: '#FFF8E1',
                            green: '#006847',
                            brown: '#4E342E'
                        }
                    },
                    fontFamily: {
                        'display': ['Rye', 'serif'],
                        'body': ['Lato', 'sans-serif'],
                    },
                    backgroundImage: {
                        'pattern': "url('data:image/svg+xml,%3Csvg width=\\'60\\' height=\\'60\\' viewBox=\\'0 0 60 60\\' xmlns=\\'http://www.w3.org/2000/svg\\'%3E%3Cg fill=\\'none\\' fill-rule=\\'evenodd\\'%3E%3Cg fill=\\'%239f0402\\' fill-opacity=\\'0.05\\'%3E%3Cpath d=\\'M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E')"
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #FFF8E1;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(159, 4, 2, 0.1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #FFF8E1;
        }
        ::-webkit-scrollbar-thumb {
            background: #9F0402;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #7c0301;
        }

        .loader-dots::after {
            content: " .";
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
            40% { color: white; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
            60% { text-shadow: .25em 0 0 white, .5em 0 0 rgba(0,0,0,0);}
            80%, 100% { text-shadow: .25em 0 0 white, .5em 0 0 white;}
        }

        /* Input Date customization */
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(18%) sepia(88%) saturate(5833%) hue-rotate(356deg) brightness(91%) contrast(116%);
        }
    </style>
</head>
<body class="font-body text-gray-800 bg-pattern min-h-screen flex flex-col">

    <!-- ==================== CLIENT VIEW ==================== -->
    <div id="clientView" class="flex-grow flex flex-col items-center justify-center p-4 sm:p-6 transition-opacity duration-500">
        
        <!-- Decoration / Logo Placeholder -->
        <div class="mb-8 text-center animate-fade-in-down">
            <div class="inline-block p-4 rounded-full border-4 border-chale-red bg-white shadow-xl mb-4">
                <i class="fas fa-pepper-hot text-4xl text-chale-red"></i>
            </div>
            <h1 class="font-display text-4xl md:text-5xl text-chale-red drop-shadow-sm tracking-wide">
                Chal√© Guadalupe
            </h1>
            <p class="text-chale-brown font-light mt-2 text-lg tracking-widest uppercase border-b-2 border-chale-yellow inline-block pb-1">
                Aut√™ntica Cozinha Mexicana
            </p>
        </div>

        <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden transform transition-all hover:scale-[1.01] duration-300 border-t-8 border-chale-red">
            <!-- Header Card -->
            <div class="bg-chale-red p-6 text-white text-center relative overflow-hidden">
                <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/az-subtle.png')]"></div>
                <h2 class="text-2xl font-bold relative z-10">Reserve sua Mesa</h2>
                <p class="text-red-100 text-sm mt-1 relative z-10">Garanta seu lugar em nossa casa</p>
            </div>

            <!-- Form Content -->
            <div id="reservationContent" class="p-6 sm:p-8">
                <form id="bookingForm" class="space-y-5">
                    
                    <!-- Nome -->
                    <div class="relative group">
                        <label for="name" class="block text-sm font-bold text-chale-brown mb-1 ml-1">
                            <i class="fas fa-user mr-1 text-chale-yellow"></i> Nome Completo
                        </label>
                        <input type="text" id="name" required 
                            class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-chale-yellow focus:ring-0 outline-none transition-colors text-gray-700 placeholder-gray-400"
                            placeholder="Ex: Jo√£o da Silva">
                    </div>

                    <!-- Telefone -->
                    <div class="relative group">
                        <label for="phone" class="block text-sm font-bold text-chale-brown mb-1 ml-1">
                            <i class="fas fa-whatsapp mr-1 text-chale-yellow"></i> WhatsApp
                        </label>
                        <input type="tel" id="phone" required 
                            class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-chale-yellow focus:ring-0 outline-none transition-colors text-gray-700 placeholder-gray-400"
                            placeholder="(11) 99999-9999">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <!-- Data -->
                        <div class="relative">
                            <label for="date" class="block text-sm font-bold text-chale-brown mb-1 ml-1">
                                <i class="fas fa-calendar-alt mr-1 text-chale-yellow"></i> Data
                            </label>
                            <input type="date" id="date" required 
                                class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-chale-yellow focus:ring-0 outline-none transition-colors text-gray-700 cursor-pointer">
                        </div>

                        <!-- Pessoas -->
                        <div class="relative">
                            <label for="people" class="block text-sm font-bold text-chale-brown mb-1 ml-1">
                                <i class="fas fa-users mr-1 text-chale-yellow"></i> Pessoas
                            </label>
                            <div class="relative">
                                <select id="people" required 
                                    class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-chale-yellow focus:ring-0 outline-none transition-colors text-gray-700 appearance-none cursor-pointer">
                                    <option value="">Qtd.</option>
                                    <option value="1">1 Pessoa</option>
                                    <option value="2">2 Pessoas</option>
                                    <option value="3">3 Pessoas</option>
                                    <option value="4">4 Pessoas</option>
                                    <option value="5">5 Pessoas</option>
                                    <option value="6">6 Pessoas</option>
                                    <option value="7">7 Pessoas</option>
                                    <option value="8">8 Pessoas</option>
                                    <option value="9">9 Pessoas</option>
                                    <option value="10">10+ Pessoas</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hor√°rio -->
                    <div class="relative">
                        <label for="time" class="block text-sm font-bold text-chale-brown mb-1 ml-1">
                            <i class="fas fa-clock mr-1 text-chale-yellow"></i> Hor√°rio Dispon√≠vel
                        </label>
                        <div class="relative">
                            <select id="time" required 
                                class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-chale-yellow focus:ring-0 outline-none transition-colors text-gray-700 appearance-none cursor-pointer disabled:bg-gray-100 disabled:text-gray-400">
                                <option value="">Selecione a data primeiro</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                                <i class="fas fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1 ml-1">*Hor√°rios sujeitos a disponibilidade</p>
                    </div>

                    <!-- Bot√£o -->
                    <button type="submit" id="submitBtn" 
                        class="w-full mt-6 bg-gradient-to-r from-chale-red to-red-700 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300 transform flex justify-center items-center group">
                        <span class="group-hover:mr-2 transition-all">Confirmar Reserva</span>
                        <i class="fas fa-arrow-right opacity-0 group-hover:opacity-100 transition-all transform translate-x-[-10px] group-hover:translate-x-0"></i>
                    </button>
                </form>
            </div>

            <!-- Confirmation State (Hidden by default) -->
            <div id="confirmationMessage" class="hidden p-8 text-center bg-white h-full flex flex-col items-center justify-center">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-6 animate-bounce">
                    <i class="fas fa-check text-4xl text-green-600"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2 font-display">Reserva Solicitada!</h3>
                <p class="text-gray-600 mb-6">Recebemos seu pedido. Em breve confirmaremos os detalhes via WhatsApp.</p>
                
                <div class="bg-gray-50 rounded-xl p-4 w-full mb-6 text-left border border-gray-200">
                    <p class="text-sm text-gray-500 mb-1">C√≥digo da Reserva</p>
                    <p class="font-mono text-lg font-bold text-chale-red" id="confCode">#------</p>
                    <div class="h-px bg-gray-200 my-2"></div>
                    <p class="text-sm text-gray-500">Detalhes:</p>
                    <p class="font-medium text-gray-800" id="confDetails">...</p>
                </div>

                <button onclick="location.reload()" 
                    class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium w-full">
                    Fazer Nova Reserva
                </button>
            </div>
        </div>
        
        <footer class="mt-8 text-chale-brown/60 text-sm text-center">
            <p>&copy; 2024 Chal√© Guadalupe. Todos os direitos reservados.</p>
        </footer>
    </div>

    <!-- ==================== HOST VIEW ==================== -->
    <div id="hostView" class="hidden min-h-screen bg-gray-100 flex flex-col">
        <!-- Top Navigation -->
        <nav class="bg-chale-red text-white shadow-lg z-10 sticky top-0">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-utensils text-xl text-chale-yellow"></i>
                        <span class="font-display text-xl font-bold tracking-wide">Painel Chal√©</span>
                    </div>
                    <div class="flex items-center space-x-4 text-sm font-medium bg-red-900/30 px-4 py-2 rounded-full">
                        <i class="far fa-clock text-chale-yellow"></i>
                        <span id="currentDateTime">Carregando...</span>
                    </div>
                </div>
            </div>
        </nav>

        <main class="flex-grow p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto w-full">
            
            <!-- Dashboard Header / Filters -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 mb-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Reservas</h2>
                        <p class="text-gray-500 text-sm">Gerencie o fluxo do sal√£o</p>
                    </div>
                    
                    <div class="flex flex-wrap gap-3">
                        <div class="relative group">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-calendar text-gray-400 group-hover:text-chale-red transition-colors"></i>
                            </div>
                            <input type="date" id="filterDate" class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-chale-red focus:border-chale-red outline-none text-sm transition-shadow">
                        </div>

                        <div class="relative group">
                             <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-clock text-gray-400 group-hover:text-chale-red transition-colors"></i>
                            </div>
                            <select id="filterTime" class="pl-10 pr-8 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-chale-red focus:border-chale-red outline-none text-sm bg-white appearance-none cursor-pointer">
                                <option value="">Todos Hor√°rios</option>
                                <option value="11:00">11:00</option>
                                <option value="11:30">11:30</option>
                                <option value="12:00">12:00</option>
                                <option value="12:30">12:30</option>
                                <option value="13:00">13:00</option>
                                <option value="13:30">13:30</option>
                                <option value="14:00">14:00</option>
                                <option value="18:00">18:00</option>
                                <option value="18:30">18:30</option>
                                <option value="19:00">19:00</option>
                                <option value="19:30">19:30</option>
                                <option value="20:00">20:00</option>
                                <option value="20:30">20:30</option>
                                <option value="21:00">21:00</option>
                                <option value="21:30">21:30</option>
                                <option value="22:00">22:00</option>
                            </select>
                             <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                <i class="fas fa-chevron-down text-xs"></i>
                            </div>
                        </div>

                        <div class="relative group">
                             <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-filter text-gray-400 group-hover:text-chale-red transition-colors"></i>
                            </div>
                            <select id="filterStatus" class="pl-10 pr-8 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-chale-red focus:border-chale-red outline-none text-sm bg-white appearance-none cursor-pointer">
                                <option value="">Todos Status</option>
                                <option value="pending">Pendentes</option>
                                <option value="confirmed">Confirmadas</option>
                                <option value="present">Presentes</option>
                                <option value="noshow">No-Show</option>
                            </select>
                             <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                <i class="fas fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Overview (Optional Polish) -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="statsContainer">
                <!-- Populated by JS -->
            </div>

            <!-- Content Grid -->
            <div id="reservationsList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                 <!-- Cards injected by JS -->
                 <div class="col-span-full text-center py-20 text-gray-400">
                     <i class="fas fa-circle-notch fa-spin text-4xl mb-3 text-chale-red"></i>
                     <p>Carregando reservas...</p>
                 </div>
            </div>
        </main>
    </div>

    <!-- ==================== JAVASCRIPT LOGIC ==================== -->
    <script>
        // ============= CONFIGURA√á√ïES DO SISTEMA (MANTIDAS) =============
        const MAX_RESERVATIONS_PER_SLOT = 5; 
        
        const AVAILABLE_TIMES = [
            "11:00", "11:30", "12:00", "12:30", "13:00", "13:30", "14:00",
            "18:00", "18:30", "19:00", "19:30", "20:00", "20:30", "21:00", "21:30", "22:00"
        ];

        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCGXNRpRxEqHQxyxzHmT6pcnxd6eFy8iQM", // Note: This key might be restricted to specific domains.
            authDomain: "sistema-de-reserva-56c90.firebaseapp.com",
            projectId: "sistema-de-reserva-56c90",
            storageBucket: "sistema-de-reserva-56c90.firebasestorage.app",
            messagingSenderId: "818842876841",
            appId: "1:818842876841:web:e616fa6aba6faeacf062b8"
        };

        // Inicializa√ß√£o Segura do Firebase
        let db = null;
        try {
            // Check if Firebase is available and not already initialized
            if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log("Firebase initialized successfully");
            } else if (typeof firebase !== 'undefined' && firebase.apps.length) {
                db = firebase.firestore();
                console.log("Firebase already initialized");
            }
        } catch (e) {
            console.warn("Firebase initialization failed, falling back to LocalStorage:", e);
        }

        // ============= LOCAL STORAGE FALLBACK CLASS (MANTIDA) =============
        class LocalStorage {
            constructor() {
                this.reservations = this.loadReservations();
            }

            loadReservations() {
                const stored = localStorage.getItem('reservations');
                return stored ? JSON.parse(stored) : [];
            }

            saveReservations() {
                localStorage.setItem('reservations', JSON.stringify(this.reservations));
            }

            addReservation(data) {
                const reservation = {
                    ...data,
                    id: Date.now().toString(),
                    createdAt: { seconds: Date.now() / 1000 } // Mimic Firebase Timestamp
                };
                this.reservations.push(reservation);
                this.saveReservations();
                return Promise.resolve({ id: reservation.id });
            }

            getReservations(filters = {}) {
                let filtered = [...this.reservations];
                
                if (filters.date) {
                    filtered = filtered.filter(r => r.date === filters.date);
                }
                if (filters.time) {
                    filtered = filtered.filter(r => r.time === filters.time);
                }
                if (filters.status) {
                    filtered = filtered.filter(r => r.status === filters.status);
                }
                
                // Sort
                filtered.sort((a, b) => {
                    const dateCompare = a.date.localeCompare(b.date);
                    if (dateCompare !== 0) return dateCompare;
                    return a.time.localeCompare(b.time);
                });
                
                return Promise.resolve(filtered);
            }

            updateReservation(id, updates) {
                const index = this.reservations.findIndex(r => r.id === id);
                if (index !== -1) {
                    this.reservations[index] = { ...this.reservations[index], ...updates };
                    this.saveReservations();
                }
                return Promise.resolve();
            }

            onSnapshot(callback) {
                setInterval(() => {
                    this.getReservations().then(callback);
                }, 1000);
                this.getReservations().then(callback);
            }
        }

        // Initialize Storage Strategy
        const storage = db ? null : new LocalStorage();

        // ============= VIEW CONTROLLER =============
        const urlParams = new URLSearchParams(window.location.search);
        const isHostView = urlParams.get('view') === 'host';

        if (isHostView) {
            document.getElementById('clientView').classList.add('hidden');
            document.getElementById('hostView').classList.remove('hidden');
            initHostView();
        } else {
            initClientView();
        }

        // ============= LOGIC: AVAILABILITY =============
        async function checkSlotAvailability(date, time) {
            try {
                let confirmedCount = 0;

                if (db) {
                    const snapshot = await db.collection('reservations')
                        .where('date', '==', date)
                        .where('time', '==', time)
                        .where('status', '==', 'confirmed')
                        .get();
                    confirmedCount = snapshot.docs.length;
                } else {
                    const reservations = await storage.getReservations({ date, time });
                    confirmedCount = reservations.filter(r => r.status === 'confirmed').length;
                }

                return confirmedCount < MAX_RESERVATIONS_PER_SLOT;
            } catch (error) {
                console.error('Error checking availability:', error);
                return true; 
            }
        }

        async function updateTimeSlots(selectedDate) {
            const timeSelect = document.getElementById('time');
            const originalText = timeSelect.options[0].text;
            
            // UI Loading State
            timeSelect.innerHTML = '<option value="">Verificando hor√°rios...</option>';
            timeSelect.disabled = true;
            timeSelect.classList.add('bg-gray-100');

            if (!selectedDate) {
                timeSelect.innerHTML = '<option value="">Selecione a data primeiro</option>';
                timeSelect.disabled = true;
                return;
            }

            const availableSlots = [];
            
            for (const time of AVAILABLE_TIMES) {
                const isAvailable = await checkSlotAvailability(selectedDate, time);
                if (isAvailable) {
                    availableSlots.push(time);
                }
            }

            timeSelect.disabled = false;
            timeSelect.classList.remove('bg-gray-100');

            if (availableSlots.length === 0) {
                timeSelect.innerHTML = '<option value="">Nenhum hor√°rio dispon√≠vel para esta data</option>';
            } else {
                timeSelect.innerHTML = '<option value="">Selecione um hor√°rio</option>' +
                    availableSlots.map(time => `<option value="${time}">${time}</option>`).join('');
            }
        }

        // ============= CLIENT VIEW LOGIC =============
        function initClientView() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('date');
            dateInput.min = today;
            dateInput.value = today;

            // Trigger updates
            dateInput.addEventListener('change', function(e) {
                updateTimeSlots(e.target.value);
            });

            // Initial load
            updateTimeSlots(today);

            // Phone Formatting
            document.getElementById('phone').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 0) {
                    if (value.length <= 11) {
                        value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                    }
                    e.target.value = value;
                }
            });

            // Form Submission
            document.getElementById('bookingForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const btn = document.getElementById('submitBtn');
                const originalBtnContent = btn.innerHTML;
                
                // Loading State UI
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Processando...';
                
                const date = document.getElementById('date').value;
                const time = document.getElementById('time').value;

                // Final Availability Check
                const isAvailable = await checkSlotAvailability(date, time);
                if (!isAvailable) {
                    alert('Desculpe, este hor√°rio acabou de ser preenchido. Por favor, escolha outro.');
                    updateTimeSlots(date);
                    btn.disabled = false;
                    btn.innerHTML = originalBtnContent;
                    return;
                }

                const reservation = {
                    name: document.getElementById('name').value,
                    phone: document.getElementById('phone').value,
                    date: date,
                    time: time,
                    people: document.getElementById('people').value,
                    status: 'pending'
                };

                try {
                    let reservationId;
                    
                    if (db) {
                        const docRef = await db.collection('reservations').add({
                            ...reservation,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        reservationId = docRef.id;
                    } else {
                        const result = await storage.addReservation(reservation);
                        reservationId = result.id;
                    }

                    // Success UI Transition
                    document.getElementById('bookingForm').style.display = 'none';
                    const confDiv = document.getElementById('confirmationMessage');
                    confDiv.classList.remove('hidden');
                    
                    // Fill confirmation details
                    const formattedDate = new Date(reservation.date + 'T00:00:00').toLocaleDateString('pt-BR');
                    document.getElementById('confCode').textContent = `#${reservationId.substring(0, 8).toUpperCase()}`;
                    document.getElementById('confDetails').innerHTML = `
                        ${reservation.name}<br>
                        ${formattedDate} √†s ${reservation.time}<br>
                        ${reservation.people} Pessoas
                    `;

                } catch (error) {
                    console.error('Error:', error);
                    alert('Erro ao processar reserva. Tente novamente.');
                    btn.disabled = false;
                    btn.innerHTML = originalBtnContent;
                }
            });
        }

        // ============= HOST VIEW LOGIC =============
        function initHostView() {
            // Clock
            function updateDateTime() {
                const now = new Date();
                const options = { weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' };
                let str = now.toLocaleDateString('pt-BR', options);
                // Capitalize first letter
                str = str.charAt(0).toUpperCase() + str.slice(1);
                document.getElementById('currentDateTime').textContent = str;
            }
            updateDateTime();
            setInterval(updateDateTime, 60000);

            // Filters
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterDate').value = today;

            ['filterDate', 'filterTime', 'filterStatus'].forEach(id => {
                document.getElementById(id).addEventListener('change', loadReservations);
            });

            // Setup Listeners
            if (db) {
                db.collection('reservations').onSnapshot(() => loadReservations());
            } else {
                storage.onSnapshot(() => loadReservations());
            }

            loadReservations();
        }

        async function loadReservations() {
            const filters = {
                date: document.getElementById('filterDate').value,
                time: document.getElementById('filterTime').value,
                status: document.getElementById('filterStatus').value
            };

            const container = document.getElementById('reservationsList');
            // Don't clear innerHTML immediately to avoid flickering if we want, but simple for now
            // container.innerHTML = 'Loading...'; 

            try {
                let reservations = [];

                if (db) {
                    let query = db.collection('reservations');
                    if (filters.date) query = query.where('date', '==', filters.date);
                    if (filters.time) query = query.where('time', '==', filters.time);
                    if (filters.status) query = query.where('status', '==', filters.status);

                    const snapshot = await query.get();
                    reservations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Sort locally for Firestore limitation on multiple fields without index
                    reservations.sort((a, b) => {
                        const timeCompare = a.time.localeCompare(b.time);
                        if (timeCompare !== 0) return timeCompare;
                        return (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0);
                    });
                } else {
                    reservations = await storage.getReservations(filters);
                }

                updateStats(reservations);
                renderHostGrid(reservations);
            } catch (error) {
                console.error("Error loading reservations:", error);
                container.innerHTML = `
                    <div class="col-span-full p-8 text-center text-red-500 bg-red-50 rounded-xl">
                        <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                        <p>Erro ao carregar dados. Verifique o console.</p>
                    </div>`;
            }
        }

        function updateStats(reservations) {
            const stats = {
                total: reservations.length,
                pending: reservations.filter(r => r.status === 'pending').length,
                confirmed: reservations.filter(r => r.status === 'confirmed').length,
                present: reservations.filter(r => r.status === 'present').length
            };

            const container = document.getElementById('statsContainer');
            // You can implement HTML generation for stats here if desired
        }

        function renderHostGrid(reservations) {
            const container = document.getElementById('reservationsList');
            
            if (reservations.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center p-12 text-gray-400 border-2 border-dashed border-gray-300 rounded-xl">
                        <i class="far fa-clipboard text-5xl mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-600">Nenhuma reserva encontrada</h3>
                        <p class="text-sm">Tente ajustar os filtros.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = reservations.map(r => {
                const statusMeta = getStatusMeta(r.status);
                const formattedDate = new Date(r.date + 'T00:00:00').toLocaleDateString('pt-BR');
                
                // WhatsApp Link Logic
                const cleanPhone = r.phone.replace(/\D/g, '');
                const whatsappNumber = cleanPhone.startsWith('55') ? cleanPhone : `55${cleanPhone}`;
                const whatsappMessage = encodeURIComponent(
                    `Ol√° ${r.name}! üëã\n\n` +
                    `Sua reserva no *Chal√© Guadalupe* est√° confirmada! ‚úÖ\n\n` +
                    `üìÖ Data: ${formattedDate}\n` +
                    `‚è∞ Hor√°rio: ${r.time}\n` +
                    `üë• Pessoas: ${r.people}\n\n` +
                    `Estamos ansiosos para receb√™-lo! üåÆ`
                );

                return `
                <div class="bg-white rounded-xl shadow-sm border-l-4 ${statusMeta.border} hover:shadow-md transition-shadow duration-200 overflow-hidden group">
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg leading-tight group-hover:text-chale-red transition-colors">${r.name}</h3>
                                <div class="text-sm text-gray-500 mt-1 flex items-center">
                                    <i class="fas fa-phone-alt text-xs mr-2 opacity-70"></i> ${r.phone}
                                </div>
                            </div>
                            <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider ${statusMeta.badge}">
                                ${statusMeta.label}
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 text-sm text-gray-600 mb-5 bg-gray-50 p-3 rounded-lg">
                            <div class="flex items-center">
                                <i class="far fa-calendar text-chale-yellow mr-2"></i> ${formattedDate}
                            </div>
                            <div class="flex items-center font-bold text-gray-800">
                                <i class="far fa-clock text-chale-yellow mr-2"></i> ${r.time}
                            </div>
                            <div class="flex items-center col-span-2">
                                <i class="fas fa-users text-chale-yellow mr-2"></i> ${r.people} Pessoas
                            </div>
                        </div>

                        <div class="flex gap-2">
                             <a href="https://wa.me/${whatsappNumber}?text=${whatsappMessage}" target="_blank"
                                onclick="updateStatus('${r.id}', 'confirmed')"
                                class="flex-1 bg-green-50 text-green-700 hover:bg-green-100 py-2 rounded-lg text-sm font-bold text-center transition flex items-center justify-center gap-2 ${r.status !== 'pending' ? 'opacity-50 pointer-events-none' : ''}">
                                <i class="fab fa-whatsapp"></i> Confirmar
                             </a>
                             
                             <button onclick="updateStatus('${r.id}', 'present')"
                                class="flex-1 bg-blue-50 text-blue-700 hover:bg-blue-100 py-2 rounded-lg text-sm font-bold transition ${r.status !== 'confirmed' ? 'opacity-50 cursor-not-allowed' : ''}" ${r.status !== 'confirmed' ? 'disabled' : ''}>
                                Check-in
                             </button>

                             <button onclick="updateStatus('${r.id}', 'noshow')"
                                class="w-10 bg-red-50 text-red-700 hover:bg-red-100 rounded-lg flex items-center justify-center transition ${['present','noshow'].includes(r.status) ? 'opacity-50 cursor-not-allowed' : ''}" ${['present','noshow'].includes(r.status) ? 'disabled' : ''}>
                                <i class="fas fa-times"></i>
                             </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function getStatusMeta(status) {
            switch(status) {
                case 'pending': return { label: 'Pendente', badge: 'bg-yellow-100 text-yellow-800', border: 'border-yellow-400' };
                case 'confirmed': return { label: 'Confirmada', badge: 'bg-green-100 text-green-800', border: 'border-green-500' };
                case 'present': return { label: 'Em Mesa', badge: 'bg-blue-100 text-blue-800', border: 'border-blue-500' };
                case 'noshow': return { label: 'No-Show', badge: 'bg-red-100 text-red-800', border: 'border-red-500' };
                default: return { label: status, badge: 'bg-gray-100 text-gray-800', border: 'border-gray-300' };
            }
        }

        async function updateStatus(reservationId, newStatus) {
            // Prevent link navigation for whatsapp button if we want to run logic first
            // Note: onclick runs before href navigation usually allows both
            
            try {
                if (db) {
                    await db.collection('reservations').doc(reservationId).update({
                        status: newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    await storage.updateReservation(reservationId, { status: newStatus });
                }
                loadReservations();
            } catch (error) {
                console.error("Error updating status:", error);
                alert("Erro ao atualizar status");
            }
        }
    </script>
</body>
</html>

